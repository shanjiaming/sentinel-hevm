# Bancor Protocol Access Control Exploit - HEVM Symbolic Analysis

## 📋 漏洞概要

**合约**: Bancor Protocol
**漏洞类型**: 访问控制缺陷
**核心问题**: `safeTransferFrom` 函数为 public，缺乏权限验证
**影响**: 攻击者可以利用用户的代币授权转移任意数量的代币

## 🎯 关键数据

| 项目 | 地址/数值 |
|------|-----------|
| **Bancor合约** | `0x5f58058C0eC971492166763c8C22632B583F667f` |
| **XBP代币合约** | `0x28dee01D53FED0Edf5f6E310BF8Ef9311513Ae40` |
| **受害者地址** | `0xfd0B4DAa7bA535741E6B5Ba28Cba24F9a816E67E` |
| **测试区块** | `10,307,563` |
| **历史攻击区块** | `10,307,564` |
| **受害者余额** | `905,987,977,635,678,910,008,152` XBP |
| **授权额度** | `30,517,969,405,419,767,184,741,663,587,441,118` XBP |
| **最大利润** | `905,987,977,635,678,910,008,152` XBP (= 受害者全部余额) |

## 🚀 运行说明

### 环境要求
- Foundry (forge, cast)
- hevm
- Z3 solver
- Alchemy API key

### 1. 具体攻击测试
```bash
# 验证漏洞利用机制
forge test --contracts ./bancor_exploit_clean.sol --match-test test_attack_concrete -vvv
```

**预期输出**:
```
[PASS] test_attack_concrete() (gas: 57122)
Logs:
  Real victim balance from mainnet: 905987 ETH
  Real allowance from mainnet: 30517969405419767 ETH
  Concrete test profit achieved: 905987 ETH
```

### 2. 符号执行边界分析
```bash
# 编译合约
forge build --ast

# 运行hevm符号执行
hevm test --prefix test_attack_symbolic \
  --rpc https://eth-mainnet.g.alchemy.com/v2/P-x0L9coIqzuhfI091DXitR7BzYbABFA \
  --number 10307563 \
  --max-iterations 1000000
```

**预期输出**:
```
Checking 1 function(s) in contract bancor_exploit_clean.sol:BancorExploit
[RUNNING] test_attack_symbolic(uint256)
   [FAIL] test_attack_symbolic
   Counterexample:
     calldata: test_attack_symbolic(905987977635678910008152)
     result:   Revert: 0x4e487b710000000000000000000000000000000000000000000000000000000000000001
```

## 📊 结果解读

### 符号执行结果
- **FAIL**: 断言 `assert(!(profit >= TARGET_PROFIT))` 失败
- **Counterexample**: 找到了可以达到目标利润的参数值
- **最大利润**: `905,987,977,635,678,910,008,152` XBP代币
- **边界**: 正好等于受害者的完整余额

### 攻击机制验证
1. ✅ 受害者确实拥有 `905,987,977,635,678,910,008,152` XBP代币
2. ✅ 受害者给Bancor授权了超额的代币使用权限
3. ✅ 攻击者可以通过 `safeTransferFrom` 转移受害者的全部代币
4. ✅ 历史交易数据与我们的分析完全一致

## 🔍 技术实现亮点

### 动态数据获取
- **智能Fork检测**: 自动判断是否需要创建mainnet fork
- **真实数据驱动**: 从实际合约动态读取受害者余额和授权
- **零硬编码**: 所有关键数据都来自链上真实状态

### 本地化策略
- **避免远程依赖**: 将外部合约调用转换为本地合约调用
- **状态精确复制**: 保持与主网相同的合约状态
- **hevm兼容**: 解决符号执行与远程调用的兼容性问题

### 代码结构
```
bancor_exploit_clean.sol
├── IERC20 interface          # 与真实合约交互
├── LocalERC20Token          # 本地ERC20实现
├── LocalBancor              # 本地Bancor实现（含漏洞）
└── BancorExploit            # 主要测试合约
    ├── setUp()              # 动态数据获取和环境设置
    ├── test_attack_concrete() # 具体攻击验证
    └── test_attack_symbolic() # 符号执行边界分析
```

## 📈 工作流程

1. **环境检测**: 判断运行环境（forge test vs hevm）
2. **数据获取**: 从真实主网合约读取victim状态
3. **本地部署**: 创建本地合约并导入真实数据
4. **漏洞验证**: 执行具体攻击测试
5. **边界分析**: 通过符号执行找到最大利润

## 🎯 关键成果

- **精确边界**: 确定最大可获得利润为受害者的完整余额
- **机制验证**: 证实攻击通过授权滥用而非余额操控
- **历史一致**: 分析结果与实际发生的攻击完全匹配
- **方法论**: 建立了真实数据驱动的符号执行分析框架 